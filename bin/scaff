#!/usr/bin/env python3.3

"""L4 Scaffolding

Example: scaff BlogPost ./src/Blog/Posts MyName\\MyApp\\Blog\\Posts

Usage:
  scaff <name> <path> [<namespace>]
"""

from docopt import docopt
import os.path
from os import listdir, makedirs

def replace_filename(path, name):
	return path.replace('_NAME_', name)

def copyfile(src, target, name, namespace):
	srcfile = open(src, 'r')
	trgfile = open(target, 'w+')

	for line in srcfile:
		line = line.replace('_NAME_', name)
		line = line.replace('_NAMESPACE_', namespace)
		trgfile.write(line)

	srcfile.close()
	trgfile.close()

def scaffold(name, target_dir, namespace):
	if not namespace:
		namespace = 'MyApp\MyNamespace'

	skel_path = os.path.dirname(os.path.realpath(__file__)) + '/skel'
	target_dir = os.path.realpath(target_dir)

	if not os.path.isdir(target_dir):
		makedirs(target_dir)

	for f in listdir(skel_path):
		src_path = os.path.realpath(os.path.join(skel_path, f))

		filename = replace_filename(os.path.basename(f), name)
		target_path = target_dir + '/' + filename
		
		if (os.path.exists(target_path)):
			print(filename, 'already exists, skipping')
		else:
			print('Copying', src_path, '->', target_path, '...')
			copyfile(src_path, target_path, name, namespace)

def main():
	args = docopt(__doc__)
	name, path = args['<name>'], os.path.realpath(args['<path>'])
	namespace = args['<namespace>']
	
	print('')
	print('Resource name:', name)
	if namespace: print('Namespace:', namespace)
	print('Target directory:', path)
	print('')

	scaffold(name, path, namespace)

	print('')
	print('Done!')
	print('')

if __name__ == '__main__':
	main()